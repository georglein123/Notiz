增加光机关机功能

client: controllernode

server: projectornode

service通道



client

**创建client**

![image-20230504140204239](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504140204239.png)

1. 新建client

```c++
initProj_cli = this->create_client<protocol::srv::ProjInit>(EToS(topics::Topic::ProjInit));

	//创建projClose_cli client，使用service通道为protocol::srv::ProjClose
    projClose_cli = this->create_client<protocol::srv::ProjClose>(EToS(topics::Topic::ProjClose));

    switchLED_cli = this->create_client<protocol::srv::ProjSwitchLED>(EToS(topics::Topic::ProjSwitchLED));
```

2. 需执行的功能

```c++
bool ControlNode::closeProjector()
{
	//确定request
    //？ 的结构在该路径下protocol::srv::ProjClose::Request
    auto req = std::make_shared<protocol::srv::ProjClose::Request>();

    //ros::Request(client,request,xx,xx)
    auto reply = ros::Request(projClose_cli, req, 5000, 30000);
    if(reply.error)
    {
        return reply.error;
    }
	//返回结果
    return reply.result->ret;
}
```



头文件声明

![image-20230504140248154](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504140248154.png)



**创建service通道及其通道文件结构**

创建一个service结构文件，设置其文件结构，client和server交流的通道，service的内容格式（点划线上方为request，下方为response）

![image-20230504142740215](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504142740215.png)



**创建server**

![image-20230504140509517](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504140509517.png)

1. 创建server

```c++
init_srv = this->create_service<protocol::srv::ProjInit>(EToS(topics::Topic::ProjInit), std::bind(&ProjectorNode::initProj, this, _1, _2));
	//创建server
    projClose_srv = this->create_service<protocol::srv::ProjClose>(EToS(topics::Topic::ProjClose), std::bind(&ProjectorNode::closeProj, this, _1, _2));

    cleanScreen_srv = this->create_service<protocol::srv::ProjCleanScreen>(EToS(topics::Topic::ProjCleanScreen), std::bind(&ProjectorNode::cleanScreen, this, _1, _2));
```

2. 需执行的功能

```c++
void ProjectorNode::closeProj(const protocol::srv::ProjClose_Request::SharedPtr req, const protocol::srv::ProjClose_Response::SharedPtr res)
{
    Q_UNUSED(req);

    res->ret = mProjector->Close();
    return ;
}

```

头文件声明

![image-20230504140551425](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504140551425.png)



添加一个空行，让其重新编译，否则cmakelist可以不会编译

![image-20230504142057622](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504142057622.png)





![image-20230504142802118](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230504142802118.png)



添加功能逻辑

进入`controller.ui`文件

找到按钮（**信号**）

![image-20230505114712579](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505114712579.png)



进入到`controller.cpp`文件中，进行功能定义（**槽函数**）

![image-20230505114830049](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505114830049.png)



光标定位到 `p`，然后按住ctrl键，点击鼠标左键

进入到头文件`controller.h`

![image-20230505115357216](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505115357216.png)



**进入到node节点的client**



光标定位到`<ControlNode>`，然后按住ctrl键，点击鼠标左键

进入到`controlnode.h`头文件

![image-20230505115639023](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505115639023.png)

光标定位到`bool closeProjector`，然后按住ctrl键，点击鼠标左键

进入到`controlnode.cpp`源文件

![image-20230505115841933](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505115841933.png)



搜索service通道名称，找到server

![image-20230505134008172](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505134008172.png)



**进入node节点的server**

![image-20230505134935948](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230505134935948.png)
