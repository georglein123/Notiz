标定逻辑

1. 设置设备类型及标定/复检
2. 读取border及calib图片（以灰度图方式）
3. 获取光机的小方格和标定板小圆点图片
4. 根据border生成绿色网格





设备类型

1. 设备类型；
2. 设备对应的各种参数；
   1. 标定点个数；
   2. 光机投的标定点图
3. 生成设备类型对应的标定图
   1. 确定各个标定点的坐标
      1. 使用np.mgird生成二维坐标系，从而确定各个标定点的坐标
   2. 以各个标定点的坐标为中心画矩形



生成绿色网格图

1. 获得border图

2. 对border图进行高斯降噪

3. 对上一步的图像分别在横向及纵向进行卷积操作，实现边缘检测

   1. 处理上述得到的浮点数据

      1. 具体地说，`cv.convertScaleAbs` 函数的工作流程如下：
      2. 将浮点型的数据类型转换为 8 位整数型。
      3. 将每个像素乘以一个尺度因子（scale factor），通常为 1 或原始值的某个分数，以便压缩输出范围。
      4. 削减低于零的像素值，使它们都等于零。
      5. 削减大于 255 的像素值（如果有），使它们都等于 255。
      6. 最后，将任何剩余像素舍入到最接近的整数值上。

      通过使用 `cv.convertScaleAbs`，我们将浮点值映射到 [0, 255] 的整数值范围内，可以方便地将其进行显示或保存。

   2. otsu自适应阈值二值化图片

4. 将横向和纵向上的梯度运算计算结果进行加权叠加

5. 执行形态学运算中的闭操作对图像进行处理，形态学闭操作可以用于去除前景中的小孔洞，填补前景物体中的小缺口，并且能够消除毛刺和极端小的斑点等。通过将闭操作应用于图像的情况，可以有效地平滑边缘并删除细节信息，从而更好地提取特征

6. 识别轮廓

7. 对识别到的多个轮廓按照周长排序，选出周长小的轮廓

8. 找到最小矩形的几何中心坐标，矩形的长和宽，旋转角度

9. 根据border矩形框的像素大小和真实物理尺寸大小，获取图片中像素和真实物理大小比率approx_pixel_mm_ratio

10. 找到对应关系，CS的标定图中1个像素在相机照片中对应多少像素面积（1个小方格有12个像素），小方格的像素面积，标定板中黑点大小在相机照片中对应多少像素面积

11. 根据最小矩形的几何中心坐标，旋转角度，确定旋转矩阵

12. 确定相机图片中上下左右四个角的坐标分别离识别到的矩形轮廓的四个角的距离大小，并找到识别到的矩形轮廓的四个角距离相机图片中上下左右四个角最小的那个点（从而才能和相机图片轮廓四个角和识别到的矩形轮廓四个角一一对应，确定左上，左下，右上，右下四个角）

13. 将左上角点2维坐标增加1个数，变成3维，和旋转矩阵相乘

14. 将最小矩形的宽和高分别除以标定图的数量，均分，确定单条绿色网格的宽度和高度

15. 确定网格的左上角坐标（将最小矩形的左上角点在x和y方向分别移动半个网格大小）和右下角坐标（将最小矩形的右下角点在x和y方向分别移动半个网格大小）

16. 然后分别在横向和纵向上画线

17. 建立一个和之前的旋转矩阵相反方向的旋转矩阵，并应用在生成的绿色网格图片上，进行仿射变换成和相机大小一致的图片

18. 然后转换成无符号的8位整型数



otsuThreshold

1. 如果是彩色图片，转换成灰度图片
2. 高斯滤波去噪
3. 灰度值小于0的全赋值为0，大于设定值的全赋值为设定值
4. 然后进行otsu二值化



标定

1. 将border和calib图转换成灰度图
2. 利用border图识别出最小矩形获得中心坐标和旋转角度，将calib图进行仿射变换矫正
3. 并根据border图识别出最小矩形的长和宽选中calib中对应区域作为处理区域
4. 根据网格的大小位置，将处理区域进行切割成和标定图中小方格数量对应一致的小块区域
5. 对单个区域，进行灰度值直方图分析，确定灰度阈值，对该图片分别处理，分别获得白点和黑点的圆心坐标
6. 然后将单个区域中获取的白点和黑点坐标和该区域的左上角坐标相加，转换到全局坐标系下，也就是相机图片的坐标系下
7. 从16x16的绿色网格的左上角点中，选择中间的10x10个点阵，计算中心点及旋转角度，获得旋转矩阵
8. 对16x16黑、白点作用旋转矩阵，然后分别输出黑、白点的所有点坐标、中心及角度
9. 利用黑点的在照片中的间距和标定板上的物理间距，确定像素/mm的比例
10. 计算16x16的所有黑点和白点中心坐标偏差
11. 将16x16的所有白点矩阵减去上面的中心坐标偏差（相当于将白点对其到黑点上）
12. 将白点坐标减去黑点坐标，即为各组白点和黑点之间的坐标偏差
13. 将坐标偏差转换成mm单位（max mm dev:），以及对应的光机投图上像素偏差（max pixel dev）
14. 将16行16列的点的x方向及y方向的偏差进行样条插值
    1. 将光机源标定图的中心点分为x坐标和y坐标
    2. 将各个点对应的偏差的x坐标和光机源标定图的x坐标组合成一个元组，



extract_pnts



transform_pnts

1. 从16x16的绿色网格的左上角点中，选择中间的10x10个点阵，计算中心点及旋转角度，获得旋转矩阵
2. 对黑、白点作用旋转矩阵，然后分别输出黑、白点的所有点坐标、中心及角度



标定板参数：

CS

```
        self.__cb.name = 'CS'
        self.__cb.gsize = (16, 16)
        self.__cb.gap_mm = (4.68, 8.32)
        self.__cb.shape = (1080, 1920)
        self.__cb.real_shape = (70.2, 124.8)
        self.__cb.mm_pixel = self.__cb.real_shape[1] / self.__cb.shape[1]
        self.__cb.square_size = (12, 12)
        self.__cb.black_spot_diameter = 0.5
        self.__cb.points = self.__gen_pnts(self.__cb.shape, self.__cb.gsize, self.__cb.square_size[0] / 2)#生成标定图的各个点坐标
        self.__cb.image = self.__gen_image(self.__cb.shape, self.__cb.points, self.__cb.square_size)#使用上面的坐标，使用矩形方法绘制标定图
```

A2D

```
        self.__cb.name = 'A2D'
        self.__cb.gsize = (16, 16)
        self.__cb.gap_mm = (5.4, 9.6)
        self.__cb.shape = (1080, 1920)
        self.__cb.real_shape = (81, 144)
        self.__cb.mm_pixel = self.__cb.real_shape[1] / self.__cb.shape[1]
        self.__cb.square_size = (6, 6)
        self.__cb.black_spot_diameter = 0.5
        self.__cb.points = self.__gen_pnts(self.__cb.shape, self.__cb.gsize, self.__cb.square_size[0] / 2)
        self.__cb.image = self.__gen_image(self.__cb.shape, self.__cb.points, self.__cb.square_size)
```

